<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Runge-Kutta Kalkulator med Feilanalyse</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<h1>Runge-Kutta (RK4) Kalkulator med Feilanalyse</h1>

<div>
    <label for="f">Differensialligning y' = f(t, y): </label>
    <input type="text" id="f" value="-2*t*y" style="width: 200px;">
</div>
<br>
<div>
    <label for="exact">Eksakt løsning y(t): </label>
    <input type="text" id="exact" value="Math.exp(-t*t)" style="width: 200px;">
</div>
<br>
<div>
    <label for="t0">Starttidspunkt t₀: </label>
    <input type="number" id="t0" value="0">
</div>
<br>
<div>
    <label for="y0">Startverdi y₀: </label>
    <input type="number" id="y0" value="1">
</div>
<br>
<div>
    <label for="start">Start av t-intervallet: </label>
    <input type="number" id="start" value="0">
</div>
<br>
<div>
    <label for="end">Slutt av t-intervallet: </label>
    <input type="number" id="end" value="2">
</div>
<br>
<div>
    <label for="n_steps">Antall steg n: </label>
    <input type="number" id="n_steps" value="1000">
</div>
<br>
<button onclick="computeAndPlot()">Kjør Beregning</button>

<h2>Resultater</h2>
<div id="plot"></div>
<div id="error_plot"></div>
<div id="slope"></div>

<script>
function computeAndPlot() {
    // Hent brukerinput
    const fInput = document.getElementById('f').value;
    const exactInput = document.getElementById('exact').value;
    const t0 = parseFloat(document.getElementById('t0').value);
    const y0 = parseFloat(document.getElementById('y0').value);
    const start = parseFloat(document.getElementById('start').value);
    const end = parseFloat(document.getElementById('end').value);
    const n_steps = parseInt(document.getElementById('n_steps').value);

    // Definer funksjonen f(t, y)
    const f = Function('t', 'y', 'return ' + fInput + ';');

    // Definer eksakt løsning
    const exact_solution = Function('t', 'return ' + exactInput + ';');

    // Beregn skrittlengde h
    const h = (1 / n_steps) * (end - start);

    // Initier lister
    let t_values = [t0];
    let y_values = [y0];
    let exact_values = [exact_solution(t0)];

    // Runge-Kutta funksjon
    function runge_kutta(f, tn, yn, h) {
        const k1 = f(tn, yn);
        const k2 = f(tn + h / 2, yn + (h / 2) * k1);
        const k3 = f(tn + h / 2, yn + (h / 2) * k2);
        const k4 = f(tn + h, yn + h * k3);

        return yn + (h / 6) * (k1 + 2 * k2 + 2 * k3 + k4);
    }

    // Beregningsloop
    let t = t0;
    let y = y0;
    while (t < end) {
        y = runge_kutta(f, t, y, h);
        t += h;
        t_values.push(t);
        y_values.push(y);
        exact_values.push(exact_solution(t));
    }

    // Plotting av løsninger
    const trace1 = {
        x: t_values,
        y: y_values,
        mode: 'lines',
        name: 'Runge-Kutta Approksimasjon (RK4)',
        line: { color: 'blue' }
    };

    const trace2 = {
        x: t_values,
        y: exact_values,
        mode: 'lines',
        name: 'Eksakt Løsning',
        line: { dash: 'dash', color: 'green' }
    };

    const data = [trace1, trace2];

    const layout = {
        title: "Sammenligning av Runge-Kutta (RK4) og Eksakt Løsning",
        xaxis: { title: 'Tid (t)' },
        yaxis: { title: 'y(t)' },
        legend: { x: 0, y: 1 },
        margin: { t: 50 }
    };

    Plotly.newPlot('plot', data, layout);

    // Feilanalyse
    // Definer ulike skrittlengder h
    const h_values = [];
    for (let x = 2; x <= 10; x++) {
        h_values.push(1 / (2 * Math.pow(2, x)));
    }

    const errors = [];

    for (let h of h_values) {
        let t = t0;
        let y = y0;
        const stop_time = 1; // Vi vil ha feilen ved t = 1
        const n_steps = Math.ceil((stop_time - t0) / h);

        for (let i = 0; i < n_steps; i++) {
            y = runge_kutta(f, t, y, h);
            t += h;
            if (t >= stop_time) {
                break;
            }
        }

        const estimated_y_at_1 = y;
        const exact_y_at_1 = exact_solution(1);
        const error = Math.abs(exact_y_at_1 - estimated_y_at_1);
        errors.push(error);
    }

    // Logaritmer av h og feil
    const log_h = h_values.map(h => Math.log(h));
    const log_errors = errors.map(err => Math.log(err));

    // Lineær regresjon for å finne konvergensordren
    function linearRegression(x, y) {
        const n = x.length;
        const sum_x = x.reduce((a, b) => a + b, 0);
        const sum_y = y.reduce((a, b) => a + b, 0);
        const sum_xy = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
        const sum_xx = x.reduce((sum, xi) => sum + xi * xi, 0);

        const slope = (n * sum_xy - sum_x * sum_y) / (n * sum_xx - sum_x * sum_x);
        const intercept = (sum_y - slope * sum_x) / n;

        return { slope: slope, intercept: intercept };
    }

    const regression = linearRegression(log_h, log_errors);
    const slope = regression.slope.toFixed(2);

    // Vis konvergensordren
    document.getElementById('slope').innerHTML = `<h3>Konvergensordren er tilnærmet lik ${slope} (bør være nær 4.00 for RK4)</h3>`;

    // Plotting av feil vs h
    const error_trace = {
        x: h_values,
        y: errors,
        mode: 'markers+lines',
        name: 'Absolutt feil ved t = 1',
        marker: { color: 'red' },
        line: { color: 'red' }
    };

    const error_data = [error_trace];

    const error_layout = {
        title: 'Logaritmisk Plott av Feil ved t = 1 for Ulike Skrittlengder',
        xaxis: { title: 'Skrittlengde h', type: 'log' },
        yaxis: { title: 'Absolutt Feil ved t = 1', type: 'log' },
        margin: { t: 50 }
    };

    Plotly.newPlot('error_plot', error_data, error_layout);
}
</script>

</body>
</html>
